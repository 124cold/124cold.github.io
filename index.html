import requests
import json
import argparse
from datetime import datetime
import sys
import os
import logging  # 添加缺失的导入

def setup_logging():
    """配置日志记录"""
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(levelname)s - %(message)s',
        handlers=[
            logging.FileHandler("whois_query.log", encoding='utf-8'),
            logging.StreamHandler()
        ]
    )
    return logging.getLogger(__name__)

def query_whois(domain: str, logger=None) -> dict:
    """
    查询指定域名的Whois信息
    
    参数:
        domain (str): 要查询的域名
        logger (logging.Logger): 日志记录器
    
    返回:
        dict: API返回的Whois信息
    """
    if logger:
        logger.info(f"开始查询域名: {domain}")
    
    url = "https://api.uutool.cn/whois/info/"
    
    # 设置请求头，模拟浏览器请求
    headers = {
        "Accept": "application/json, text/javascript, */*; q=0.01",
        "Accept-Encoding": "gzip, deflate, br, zstd",
        "Accept-Language": "zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6",
        "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
        "Origin": "https://www.whoiscx.com",
        "Referer": "https://www.whoiscx.com/",
        "Sec-Fetch-Dest": "empty",
        "Sec-Fetch-Mode": "cors",
        "Sec-Fetch-Site": "cross-site",
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Safari/537.36 Edg/136.0.0.0",
        "X-Requested-With": "XMLHttpRequest"
    }
    
    # 设置请求参数
    data = {
        "domain": domain
    }
    
    try:
        if logger:
            logger.debug(f"请求URL: {url}")
            logger.debug(f"请求头: {headers}")
            logger.debug(f"请求参数: {data}")
        
        # 发送POST请求，设置超时时间
        response = requests.post(url, headers=headers, data=data, timeout=30)
        
        if logger:
            logger.debug(f"响应状态码: {response.status_code}")
            logger.debug(f"响应头: {response.headers}")
            # 限制响应内容长度，避免日志过大
            content = response.text[:1000] + ("..." if len(response.text) > 1000 else "")
            logger.debug(f"响应内容: {content}")
        
        # 检查响应状态码
        response.raise_for_status()
        
        # 解析JSON响应
        result = response.json()
        if logger:
            logger.info(f"查询成功，返回数据结构: {list(result.keys())}")
        return result
    except requests.exceptions.RequestException as e:
        error_msg = f"请求发生错误: {e}"
        if logger:
            logger.error(error_msg)
        return {"error": error_msg, "status_code": getattr(e.response, "status_code", "unknown")}
    except json.JSONDecodeError as e:
        error_msg = f"解析响应JSON失败: {e}，响应内容: {response.text[:200]}..."
        if logger:
            logger.error(error_msg)
        return {"error": error_msg}
    except Exception as e:
        error_msg = f"发生未知错误: {e}"
        if logger:
            logger.error(error_msg, exc_info=True)
        return {"error": error_msg}

def format_whois_info(info: dict) -> str:
    """
    格式化Whois信息以便于阅读
    
    参数:
        info (dict): Whois信息字典
    
    返回:
        str: 格式化后的文本
    """
    if "error" in info:
        return f"查询失败: {info['error']}"
    
    # 检查是否有实际的Whois数据
    if not any(key in info for key in ["domain", "registrar", "creation_date"]):
        return f"未获取到Whois信息，原始响应: {info}"
    
    formatted = []
    
    # 尝试多种可能的键名获取域名信息
    domain = info.get('domain') or info.get('Domain') or info.get('domain_name') or "未知"
    formatted.append(f"域名: {domain}")
    
    # 注册商信息
    registrar = info.get('registrar') or info.get('Registrar') or "未知"
    formatted.append(f"注册商: {registrar}")
    
    # 格式化日期
    for date_key in ['creation_date', 'Creation Date', 'created']:
        creation_date = info.get(date_key)
        if creation_date:
            break
    else:
        creation_date = None
    
    if creation_date:
        try:
            # 尝试多种日期格式解析
            try:
                date_obj = datetime.fromisoformat(creation_date.replace('Z', '+00:00'))
            except ValueError:
                # 尝试其他常见格式
                date_formats = [
                    "%Y-%m-%dT%H:%M:%S.%fZ",
                    "%Y-%m-%d %H:%M:%S",
                    "%Y-%m-%d"
                ]
                date_obj = None
                for fmt in date_formats:
                    try:
                        date_obj = datetime.strptime(creation_date, fmt)
                        break
                    except ValueError:
                        continue
                if not date_obj:
                    raise ValueError("无法解析日期格式")
            
            formatted.append(f"创建日期: {date_obj.strftime('%Y-%m-%d %H:%M:%S')}")
        except Exception as e:
            formatted.append(f"创建日期: {creation_date} (解析失败: {e})")
    else:
        formatted.append("创建日期: 未知")
    
    # 过期日期
    for date_key in ['expiration_date', 'Expiration Date', 'expires']:
        expiration_date = info.get(date_key)
        if expiration_date:
            break
    else:
        expiration_date = None
    
    if expiration_date:
        try:
            try:
                date_obj = datetime.fromisoformat(expiration_date.replace('Z', '+00:00'))
            except ValueError:
                date_formats = [
                    "%Y-%m-%dT%H:%M:%S.%fZ",
                    "%Y-%m-%d %H:%M:%S",
                    "%Y-%m-%d"
                ]
                date_obj = None
                for fmt in date_formats:
                    try:
                        date_obj = datetime.strptime(expiration_date, fmt)
                        break
                    except ValueError:
                        continue
                if not date_obj:
                    raise ValueError("无法解析日期格式")
            
            formatted.append(f"过期日期: {date_obj.strftime('%Y-%m-%d %H:%M:%S')}")
        except Exception as e:
            formatted.append(f"过期日期: {expiration_date} (解析失败: {e})")
    else:
        formatted.append("过期日期: 未知")
    
    # 添加其他信息
    status = info.get('status') or info.get('Status') or "未知"
    formatted.append(f"状态: {status}")
    
    # 名称服务器
    nameservers = info.get('nameservers') or info.get('Name Server') or info.get('nameserver')
    if nameservers:
        if isinstance(nameservers, list):
            formatted.append(f"名称服务器: {', '.join(nameservers)}")
        else:
            formatted.append(f"名称服务器: {nameservers}")
    else:
        formatted.append("名称服务器: 未知")
    
    # 添加WHOIS服务器信息
    whois_server = info.get('whois_server') or info.get('Whois Server') or info.get('whois')
    if whois_server:
        formatted.append(f"WHOIS服务器: {whois_server}")
    
    # 添加联系信息
    registrant = info.get('registrant') or info.get('Registrant') or {}
    if registrant and isinstance(registrant, dict):
        formatted.append("\n注册人信息:")
        formatted.append(f"  组织: {registrant.get('organization', '未知')}")
        formatted.append(f"  国家: {registrant.get('country', '未知')}")
    
    return "\n".join(formatted)

def main():
    """主函数，处理命令行参数并执行查询"""
    parser = argparse.ArgumentParser(description='查询域名Whois信息')
    parser.add_argument('domain', help='要查询的域名')
    parser.add_argument('-o', '--output', help='将结果保存到文件')
    parser.add_argument('-p', '--pretty', action='store_true', help='美化输出JSON')
    parser.add_argument('-d', '--debug', action='store_true', help='启用调试模式')
    
    args = parser.parse_args()
    
    # 设置日志
    logger = setup_logging()
    if not args.debug:
        logger.setLevel(logging.WARNING)
    
    # 查询Whois信息
    result = query_whois(args.domain, logger)
    
    # 输出结果
    if args.pretty:
        output = json.dumps(result, ensure_ascii=False, indent=2)
    else:
        output = format_whois_info(result)
    
    if args.output:
        try:
            with open(args.output, 'w', encoding='utf-8') as f:
                f.write(output)
            logger.info(f"结果已保存到 {args.output}")
        except Exception as e:
            logger.error(f"保存文件失败: {e}")
            print(output)
    else:
        print(output)

if __name__ == "__main__":
    main()    
